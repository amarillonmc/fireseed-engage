<?php
// ÂåÖÂê´ÂàùÂßãÂåñÊñá‰ª∂
require_once 'includes/init.php';

// Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
if (!isset($_SESSION['user_id'])) {
    header('Location: login.php');
    exit;
}

// Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
$user = new User($_SESSION['user_id']);
if (!$user->isValid()) {
    session_unset();
    session_destroy();
    header('Location: login.php');
    exit;
}

// Ëé∑ÂèñÁî®Êà∑ËµÑÊ∫ê
$resource = new Resource($user->getUserId());

// Ëé∑ÂèñÁî®Êà∑ÂüéÊ±†
$cities = City::getUserCities($user->getUserId());
$mainCity = City::getUserMainCity($user->getUserId());

// Ëé∑ÂèñÁî®Êà∑Ê≠¶Â∞Ü
$generals = General::getUserGenerals($user->getUserId());

// Ëé∑ÂèñÁî®Êà∑ÂÜõÈòü
$armies = Army::getUserArmies($user->getUserId());

// Ëé∑ÂèñÁî®Êà∑ÁßëÊäÄÊïàÊûú
$technologyEffects = UserTechnology::getUserTechnologyEffects($user->getUserId());

// ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
$totalCities = count($cities);
$totalGenerals = count($generals);
$totalArmies = count($armies);

// ËÆ°ÁÆóÊÄªÊàòÊñóÂäõ
$totalCombatPower = 0;
foreach ($armies as $army) {
    $totalCombatPower += $army->getCombatPower();
}

// È°µÈù¢Ê†áÈ¢ò
$pageTitle = 'Áî®Êà∑Ê°£Ê°à';
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo SITE_NAME; ?> - <?php echo $pageTitle; ?></title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        
        .profile-name {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .profile-level {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stats-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .stats-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .stats-item:last-child {
            border-bottom: none;
        }
        
        .stats-label {
            color: #7f8c8d;
        }
        
        .stats-value {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .resource-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .resource-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .resource-name {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .resource-amount {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .technologies-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .tech-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .tech-item:last-child {
            border-bottom: none;
        }
        
        .tech-name {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .tech-effect {
            color: #27ae60;
            font-weight: bold;
        }
        
        .cities-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .city-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .city-item:last-child {
            border-bottom: none;
        }
        
        .city-name {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .city-coords {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .city-main {
            background: #f39c12;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .generals-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        
        .rarity-count {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .rarity-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .rarity-number {
            font-size: 18px;
            font-weight: bold;
        }
        
        .rarity-B { color: #95a5a6; }
        .rarity-A { color: #3498db; }
        .rarity-S { color: #9b59b6; }
        .rarity-SS { color: #e74c3c; }
        .rarity-P { color: #f39c12; }
        
        .no-data {
            text-align: center;
            color: #7f8c8d;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- È°µÈ¶ñ -->
        <header>
            <h1 class="site-title"><?php echo SITE_NAME; ?></h1>
            <h2 class="page-title"><?php echo $pageTitle; ?></h2>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.php">‰∏ªÂü∫Âú∞</a></li>
                    <li><a href="profile.php">Ê°£Ê°à</a></li>
                    <li><a href="generals.php">Ê≠¶Â∞Ü</a></li>
                    <li><a href="armies.php">ÂÜõÈòü</a></li>
                    <li><a href="map.php">Âú∞Âõæ</a></li>
                    <li><a href="territory.php">È¢ÜÂú∞</a></li>
                    <li><a href="internal.php">ÂÜÖÊîø</a></li>
                    <li><a href="ranking.php">ÊéíÂêç</a></li>
                    <li class="circuit-points">ÊÄùËÄÉÂõûË∑Ø: <?php echo $user->getCircuitPoints(); ?> / <?php echo $user->getMaxCircuitPoints(); ?></li>
                </ul>
            </nav>
        </header>

        <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
        <main>
            <div class="profile-container">
                <!-- Áî®Êà∑‰ø°ÊÅØÂ§¥ÈÉ® -->
                <div class="profile-header">
                    <div class="profile-avatar">üë§</div>
                    <div class="profile-name"><?php echo htmlspecialchars($user->getUsername()); ?></div>
                    <div class="profile-level">Á≠âÁ∫ß <?php echo $user->getLevel(); ?></div>
                </div>

                <!-- ÁªüËÆ°Êï∞ÊçÆÁΩëÊ†º -->
                <div class="stats-grid">
                    <!-- Âü∫Á°ÄÁªüËÆ° -->
                    <div class="stats-card">
                        <div class="stats-title">
                            <span class="stats-icon">üìä</span>
                            Âü∫Á°ÄÁªüËÆ°
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Áî®Êà∑Á≠âÁ∫ß</span>
                            <span class="stats-value"><?php echo $user->getLevel(); ?></span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">ÂüéÊ±†Êï∞Èáè</span>
                            <span class="stats-value"><?php echo $totalCities; ?></span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Ê≠¶Â∞ÜÊï∞Èáè</span>
                            <span class="stats-value"><?php echo $totalGenerals; ?></span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">ÂÜõÈòüÊï∞Èáè</span>
                            <span class="stats-value"><?php echo $totalArmies; ?></span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">ÊÄªÊàòÊñóÂäõ</span>
                            <span class="stats-value"><?php echo number_format($totalCombatPower); ?></span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Ê≠¶Â∞ÜË¥πÁî®‰∏äÈôê</span>
                            <span class="stats-value"><?php echo $user->getMaxGeneralCost(); ?></span>
                        </div>
                    </div>

                    <!-- ËµÑÊ∫êÁªüËÆ° -->
                    <div class="stats-card">
                        <div class="stats-title">
                            <span class="stats-icon">üíé</span>
                            ËµÑÊ∫êÁªüËÆ°
                        </div>
                        <div class="resources-grid">
                            <div class="resource-item">
                                <div class="resource-icon">‚ö™</div>
                                <div class="resource-name">‰∫ÆÊô∂Êô∂</div>
                                <div class="resource-amount"><?php echo number_format($resource->getBrightCrystal()); ?></div>
                            </div>
                            <div class="resource-item">
                                <div class="resource-icon">üî¥</div>
                                <div class="resource-name">ÊöñÊ¥ãÊ¥ã</div>
                                <div class="resource-amount"><?php echo number_format($resource->getWarmCrystal()); ?></div>
                            </div>
                            <div class="resource-item">
                                <div class="resource-icon">üîµ</div>
                                <div class="resource-name">ÂÜ∑ÂÜ∞ÂÜ∞</div>
                                <div class="resource-amount"><?php echo number_format($resource->getColdCrystal()); ?></div>
                            </div>
                            <div class="resource-item">
                                <div class="resource-icon">üü¢</div>
                                <div class="resource-name">ÈÉÅËêåËêå</div>
                                <div class="resource-amount"><?php echo number_format($resource->getGreenCrystal()); ?></div>
                            </div>
                            <div class="resource-item">
                                <div class="resource-icon">üü°</div>
                                <div class="resource-name">ÊòºÈó™Èó™</div>
                                <div class="resource-amount"><?php echo number_format($resource->getDayCrystal()); ?></div>
                            </div>
                            <div class="resource-item">
                                <div class="resource-icon">‚ö´</div>
                                <div class="resource-name">Â§úÈùôÈùô</div>
                                <div class="resource-amount"><?php echo number_format($resource->getNightCrystal()); ?></div>
                            </div>
                        </div>
                    </div>

                    <!-- Ê≠¶Â∞ÜÁªüËÆ° -->
                    <div class="stats-card">
                        <div class="stats-title">
                            <span class="stats-icon">‚öîÔ∏è</span>
                            Ê≠¶Â∞ÜÁªüËÆ°
                        </div>
                        <?php if (!empty($generals)): ?>
                        <?php
                            $rarityCounts = ['B' => 0, 'A' => 0, 'S' => 0, 'SS' => 0, 'P' => 0];
                            foreach ($generals as $general) {
                                $rarity = $general->getRarity();
                                if (isset($rarityCounts[$rarity])) {
                                    $rarityCounts[$rarity]++;
                                }
                            }
                        ?>
                        <div class="generals-summary">
                            <?php foreach ($rarityCounts as $rarity => $count): ?>
                            <div class="rarity-count">
                                <div class="rarity-label"><?php echo $rarity; ?>Á∫ß</div>
                                <div class="rarity-number rarity-<?php echo $rarity; ?>"><?php echo $count; ?></div>
                            </div>
                            <?php endforeach; ?>
                        </div>
                        <?php else: ?>
                        <div class="no-data">ÊöÇÊó†Ê≠¶Â∞Ü</div>
                        <?php endif; ?>
                    </div>

                    <!-- ÁßëÊäÄÊïàÊûú -->
                    <div class="stats-card">
                        <div class="stats-title">
                            <span class="stats-icon">üî¨</span>
                            ÁßëÊäÄÊïàÊûú
                        </div>
                        <?php if (!empty($technologyEffects)): ?>
                        <div class="technologies-list">
                            <?php foreach ($technologyEffects as $effect): ?>
                            <div class="tech-item">
                                <span class="tech-name"><?php echo $effect['name']; ?> (Lv.<?php echo $effect['level']; ?>)</span>
                                <span class="tech-effect">+<?php echo number_format($effect['effect_value'] * 100, 1); ?>%</span>
                            </div>
                            <?php endforeach; ?>
                        </div>
                        <?php else: ?>
                        <div class="no-data">ÊöÇÊó†ÁßëÊäÄÊïàÊûú</div>
                        <?php endif; ?>
                    </div>

                    <!-- ÂüéÊ±†ÂàóË°® -->
                    <div class="stats-card">
                        <div class="stats-title">
                            <span class="stats-icon">üè∞</span>
                            ÂüéÊ±†ÂàóË°®
                        </div>
                        <?php if (!empty($cities)): ?>
                        <div class="cities-list">
                            <?php foreach ($cities as $city): ?>
                            <?php $coordinates = $city->getCoordinates(); ?>
                            <div class="city-item">
                                <div>
                                    <div class="city-name">
                                        <?php echo htmlspecialchars($city->getName()); ?>
                                        <?php if ($mainCity && $city->getCityId() == $mainCity->getCityId()): ?>
                                        <span class="city-main">‰∏ªÂüé</span>
                                        <?php endif; ?>
                                    </div>
                                    <div class="city-coords">(<?php echo $coordinates[0]; ?>, <?php echo $coordinates[1]; ?>)</div>
                                </div>
                                <div>
                                    <button onclick="window.location.href='index.php?city_id=<?php echo $city->getCityId(); ?>'">
                                        Êü•Áúã
                                    </button>
                                </div>
                            </div>
                            <?php endforeach; ?>
                        </div>
                        <?php else: ?>
                        <div class="no-data">ÊöÇÊó†ÂüéÊ±†</div>
                        <?php endif; ?>
                    </div>

                    <!-- Ë¥¶Êà∑‰ø°ÊÅØ -->
                    <div class="stats-card">
                        <div class="stats-title">
                            <span class="stats-icon">üë§</span>
                            Ë¥¶Êà∑‰ø°ÊÅØ
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Áî®Êà∑Âêç</span>
                            <span class="stats-value"><?php echo htmlspecialchars($user->getUsername()); ?></span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">ÈÇÆÁÆ±</span>
                            <span class="stats-value"><?php echo htmlspecialchars($user->getEmail()); ?></span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Ê≥®ÂÜåÊó∂Èó¥</span>
                            <span class="stats-value"><?php echo date('Y-m-d', strtotime($user->getCreatedAt())); ?></span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">ÊúÄÂêéÁôªÂΩï</span>
                            <span class="stats-value"><?php echo date('Y-m-d H:i', strtotime($user->getLastLogin())); ?></span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- È°µËÑö -->
        <footer>
            <p>&copy; <?php echo date('Y'); ?> <?php echo SITE_NAME; ?> - ÁâàÊú¨ <?php echo GAME_VERSION; ?></p>
        </footer>
    </div>
</body>
</html>
